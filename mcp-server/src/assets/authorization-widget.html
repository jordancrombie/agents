<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Authorization</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      color: #e4e4e7;
      padding: 0;
      margin: 0;
    }
    .card {
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 16px;
      overflow: hidden;
      max-width: 420px;
    }
    .header {
      padding: 20px 24px;
      border-bottom: 1px solid #3f3f46;
    }
    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: #fafafa;
      margin-bottom: 8px;
    }
    .header-subtitle {
      font-size: 14px;
      color: #a1a1aa;
      line-height: 1.5;
    }
    .details {
      padding: 20px 24px;
      border-bottom: 1px solid #3f3f46;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #3f3f46;
    }
    .detail-label {
      font-size: 14px;
      color: #a1a1aa;
    }
    .detail-value {
      font-size: 14px;
      color: #fafafa;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }
    .qr-section {
      padding: 24px;
      text-align: center;
      border-bottom: 1px solid #3f3f46;
    }
    .qr-container {
      background: #fafafa;
      border-radius: 12px;
      padding: 16px;
      display: inline-block;
      margin-bottom: 12px;
    }
    .qr-container img {
      width: 160px;
      height: 160px;
      display: block;
    }
    .qr-label {
      font-size: 13px;
      color: #71717a;
    }
    .divider {
      display: flex;
      align-items: center;
      padding: 0 24px;
      color: #71717a;
      font-size: 12px;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #3f3f46;
    }
    .divider span {
      padding: 12px 16px;
    }
    .code-section {
      padding: 16px 24px;
      text-align: center;
    }
    .code-label {
      font-size: 12px;
      color: #71717a;
      margin-bottom: 6px;
    }
    .code-value {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 20px;
      font-weight: 700;
      color: #fafafa;
      letter-spacing: 1px;
      padding: 10px 16px;
      background: #18181b;
      border-radius: 8px;
      display: inline-block;
    }
    .actions {
      padding: 20px 24px;
      display: flex;
      gap: 12px;
    }
    .btn {
      flex: 1;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.15s ease;
    }
    .btn-primary {
      background: #fafafa;
      color: #18181b;
    }
    .btn-primary:hover {
      background: #e4e4e7;
    }
    .btn-secondary {
      background: transparent;
      color: #fafafa;
      border: 1px solid #3f3f46;
    }
    .btn-secondary:hover {
      background: #3f3f46;
    }
    .status-bar {
      padding: 14px 24px;
      background: #18181b;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #facc15;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .status-dot.approved {
      background: #22c55e;
      animation: none;
    }
    .status-dot.denied {
      background: #ef4444;
      animation: none;
    }
    .status-dot.expired {
      background: #71717a;
      animation: none;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .status-text {
      font-size: 13px;
      color: #a1a1aa;
    }
    .status-text.approved {
      color: #22c55e;
    }
    .status-text.denied {
      color: #ef4444;
    }
    .notification-badge {
      background: #166534;
      color: #bbf7d0;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin: 0 24px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .notification-badge svg {
      flex-shrink: 0;
    }
    .hidden {
      display: none !important;
    }
    .expires {
      font-size: 12px;
      color: #71717a;
      text-align: center;
      padding: 8px 24px 0;
    }
    .error-msg {
      background: #7f1d1d;
      color: #fecaca;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 0 24px 16px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="header-title" id="title">Complete checkout</div>
      <div class="header-subtitle" id="subtitle">Authorize payment to complete your purchase</div>
    </div>

    <div class="details">
      <div class="detail-row">
        <span class="detail-label">Merchant</span>
        <span class="detail-value" id="merchant">Loading...</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Items</span>
        <span class="detail-value" id="items">Loading...</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Amount</span>
        <span class="detail-value" id="amount">$0.00</span>
      </div>
    </div>

    <div id="notification-banner" class="notification-badge hidden">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901z"/>
      </svg>
      <span>Push notification sent to your phone</span>
    </div>

    <div id="error-banner" class="error-msg hidden"></div>

    <div class="qr-section" id="qr-section">
      <div class="qr-container">
        <img id="qr-code" src="" alt="Scan to authorize" />
      </div>
      <div class="qr-label">Scan with WSIM wallet app</div>
    </div>

    <div class="divider"><span>or</span></div>

    <div class="code-section">
      <div class="code-label">Enter code manually</div>
      <div class="code-value" id="user-code">WSIM-XXXXXX</div>
    </div>

    <div class="expires" id="expires"></div>

    <div class="actions">
      <a id="auth-link" class="btn btn-primary" href="#" target="_blank">
        Open Authorization
      </a>
    </div>

    <div class="status-bar">
      <div class="status-dot" id="status-dot"></div>
      <div class="status-text" id="status-text">Waiting for authorization...</div>
    </div>
  </div>

  <script>
    // OpenAI Apps SDK bridge
    const openai = window.openai;
    let pollInterval = null;
    let deviceCode = null;

    async function initialize() {
      try {
        // Try multiple ways to get the tool output
        let data = null;

        // Debug: log what's available on window.openai
        console.log('Widget init - openai object:', openai);
        if (openai) {
          console.log('openai keys:', Object.keys(openai));
          console.log('openai.toolOutput:', openai.toolOutput);
          console.log('openai.structuredContent:', openai.structuredContent);
        }

        // Method 1: Try toolOutput property (per SDK docs)
        if (!data && openai && openai.toolOutput) {
          console.log('Trying openai.toolOutput property');
          data = openai.toolOutput;
          // Check if it's wrapped in structuredContent
          if (data && data.structuredContent) {
            data = data.structuredContent;
          }
        }

        // Method 2: Try structuredContent directly
        if (!data && openai && openai.structuredContent) {
          console.log('Trying openai.structuredContent');
          data = openai.structuredContent;
        }

        // Method 3: Try getToolOutput() function
        if (!data && openai && typeof openai.getToolOutput === 'function') {
          console.log('Trying openai.getToolOutput()');
          try {
            const result = await openai.getToolOutput();
            console.log('getToolOutput result:', result);
            data = result;
            // Check if it's wrapped in structuredContent
            if (data && data.structuredContent) {
              data = data.structuredContent;
            }
          } catch (e) {
            console.warn('getToolOutput failed:', e);
          }
        }

        // Method 4: Try toolResponseMetadata
        if (!data && openai && openai.toolResponseMetadata) {
          console.log('Trying openai.toolResponseMetadata');
          data = openai.toolResponseMetadata;
        }

        // Fallback: URL params
        if (!data) {
          const params = new URLSearchParams(window.location.search);
          const encoded = params.get('data');
          if (encoded) {
            console.log('Trying URL params fallback');
            try {
              data = JSON.parse(atob(encoded));
            } catch (e) {
              console.warn('URL data parse failed:', e);
            }
          }
        }

        // Fallback: window.TOOL_OUTPUT
        if (!data && window.TOOL_OUTPUT) {
          console.log('Trying window.TOOL_OUTPUT fallback');
          data = window.TOOL_OUTPUT;
        }

        console.log('Final data:', data);

        if (data) {
          updateUI(data);
          deviceCode = data.device_code;
          if (deviceCode) {
            startPolling(deviceCode);
          }
        } else {
          showError('Unable to load payment details. Check browser console for debug info.');
        }
      } catch (error) {
        console.error('Widget init error:', error);
        showError('Failed to initialize: ' + error.message);
      }
    }

    function showError(msg) {
      const banner = document.getElementById('error-banner');
      banner.textContent = msg;
      banner.classList.remove('hidden');
    }

    function updateUI(data) {
      // Title based on context
      if (data.checkout_session_id) {
        document.getElementById('title').textContent = 'Complete checkout';
        document.getElementById('subtitle').textContent =
          'Authorize payment to complete your purchase';
      } else {
        document.getElementById('title').textContent = 'Payment Authorization';
        document.getElementById('subtitle').textContent =
          'Authorize this payment request';
      }

      // Merchant
      const merchant = data.merchant_name || 'SACP Demo Store';
      document.getElementById('merchant').textContent = merchant;

      // Items/Description
      const items = data.description || data.items || 'Purchase';
      document.getElementById('items').textContent = items;

      // Amount
      if (data.amount !== undefined) {
        const currency = data.currency || 'CAD';
        const amount = parseFloat(data.amount).toFixed(2);
        document.getElementById('amount').textContent = `$${amount} ${currency}`;
      }

      // QR code
      if (data.qr_code_base64) {
        const qrImg = document.getElementById('qr-code');
        qrImg.src = `data:image/png;base64,${data.qr_code_base64}`;
        qrImg.onerror = () => {
          document.getElementById('qr-section').classList.add('hidden');
        };
      } else {
        document.getElementById('qr-section').classList.add('hidden');
      }

      // Authorization link
      if (data.authorization_url) {
        document.getElementById('auth-link').href = data.authorization_url;
      }

      // User code
      if (data.user_code) {
        document.getElementById('user-code').textContent = data.user_code;
      }

      // Notification banner
      if (data.notification_sent) {
        document.getElementById('notification-banner').classList.remove('hidden');
      }

      // Expiration
      if (data.expires_in) {
        const minutes = Math.floor(data.expires_in / 60);
        document.getElementById('expires').textContent =
          `Expires in ${minutes} minute${minutes !== 1 ? 's' : ''}`;
      }
    }

    function updateStatus(status, message) {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');

      dot.classList.remove('approved', 'denied', 'expired');
      text.classList.remove('approved', 'denied');

      switch (status) {
        case 'pending':
          text.textContent = message || 'Waiting for authorization...';
          break;
        case 'approved':
          dot.classList.add('approved');
          text.classList.add('approved');
          text.textContent = message || 'Payment authorized!';
          stopPolling();
          break;
        case 'denied':
          dot.classList.add('denied');
          text.classList.add('denied');
          text.textContent = message || 'Authorization denied';
          stopPolling();
          break;
        case 'expired':
          dot.classList.add('expired');
          text.textContent = message || 'Authorization expired';
          stopPolling();
          break;
      }
    }

    async function checkStatus(code) {
      if (!openai || typeof openai.callTool !== 'function') {
        console.warn('openai.callTool not available');
        return;
      }

      try {
        const result = await openai.callTool('device_authorize_status', {
          device_code: code
        });

        if (result && result.structuredContent) {
          const data = result.structuredContent;
          updateStatus(data.status, data.message);
        } else if (result && result.content) {
          // Parse from text content as fallback
          const text = result.content[0]?.text || '';
          if (text.includes('approved')) {
            updateStatus('approved', 'Payment authorized!');
          } else if (text.includes('denied')) {
            updateStatus('denied', 'Authorization denied');
          } else if (text.includes('expired')) {
            updateStatus('expired', 'Authorization expired');
          }
        }
      } catch (error) {
        console.warn('Status check failed:', error);
        // Don't show error, just keep polling
      }
    }

    function startPolling(code) {
      pollInterval = setInterval(() => checkStatus(code), 4000);
      // Initial check after short delay
      setTimeout(() => checkStatus(code), 1000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
  </script>
</body>
</html>
