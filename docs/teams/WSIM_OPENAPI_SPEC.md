# WSIM Team - OpenAPI & Agent Discovery Specification

**For**: WSIM Team
**Date**: 2026-01-22
**Priority**: P1
**Status**: ✅ **COMPLETE** (v1.0.7)

---

## Implementation Status

| Endpoint | Status | Notes |
|----------|--------|-------|
| `/.well-known/openapi.json` | ✅ Complete | Serves OpenAPI 3.0 spec from `docs/sacp/openapi-agent.yaml` |
| `/.well-known/agent-api` | ✅ Complete | Agent discovery document with registration, OAuth, and API info |
| `/.well-known/oauth-authorization-server` | ✅ Complete | RFC 8414 OAuth metadata |

**Implementation**: See [well-known.ts](https://github.com/jordancrombie/wsim/blob/agentic-support/backend/src/routes/well-known.ts)

**Authoritative Spec**: The actual OpenAPI specification is at `docs/sacp/openapi-agent.yaml`. The spec below is an earlier draft and may not match the implementation.

---

## Overview

To enable external AI agents to discover and use WSIM's agent APIs, we need to:
1. Publish an OpenAPI 3.0 specification at `/.well-known/openapi.json`
2. Publish an agent discovery document at `/.well-known/agent-api`
3. Add OAuth 2.0 discovery at `/.well-known/oauth-authorization-server` (RFC 8414)

---

## Task 1: OpenAPI Specification

**Endpoint**: `GET /.well-known/openapi.json`
**Content-Type**: `application/json`

Create an OpenAPI 3.0 spec describing all agent endpoints:

```yaml
openapi: 3.0.3
info:
  title: WSIM Agent API
  description: |
    Wallet API for AI agents. Enables agents to:
    - Register with user wallets via pairing codes
    - Request payment authorization tokens
    - Check spending limits
    - Handle step-up approvals for large purchases
  version: 1.0.6
  contact:
    name: SimToolBox
    url: https://wsim.banksim.ca

servers:
  - url: https://wsim-dev.banksim.ca
    description: Development
  - url: https://wsim.banksim.ca
    description: Production

paths:
  /api/agent/v1/register:
    post:
      operationId: registerAgent
      summary: Register agent with pairing code
      description: |
        Submit a pairing code to request access to a user's wallet.
        The pairing code is generated by the user in their mobile wallet app.
        After submission, the user will be prompted to approve the request.
      tags:
        - Registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pairing_code
                - agent_name
                - agent_description
              properties:
                pairing_code:
                  type: string
                  description: 6-character pairing code from user's wallet app
                  example: "ABC123"
                agent_name:
                  type: string
                  description: Display name for this agent
                  example: "Shopping Assistant"
                agent_description:
                  type: string
                  description: Description of agent's purpose
                  example: "AI assistant for online shopping"
                callback_url:
                  type: string
                  format: uri
                  description: Optional webhook URL for credential delivery
      responses:
        '202':
          description: Registration request submitted, awaiting user approval
          content:
            application/json:
              schema:
                type: object
                properties:
                  request_id:
                    type: string
                    description: ID to poll for approval status
                  status:
                    type: string
                    enum: [pending]
                  expires_at:
                    type: string
                    format: date-time
        '400':
          description: Invalid pairing code

  /api/agent/v1/register/{request_id}/status:
    get:
      operationId: getRegistrationStatus
      summary: Check registration approval status
      tags:
        - Registration
      parameters:
        - name: request_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Registration status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [pending, approved, rejected, expired]
                  client_id:
                    type: string
                    description: Only present if approved
                  client_secret:
                    type: string
                    description: Only present if approved (shown once)

  /api/agent/v1/oauth/token:
    post:
      operationId: getAccessToken
      summary: Exchange credentials for access token
      description: OAuth 2.0 client credentials flow
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - grant_type
                - client_id
                - client_secret
              properties:
                grant_type:
                  type: string
                  enum: [client_credentials]
                client_id:
                  type: string
                client_secret:
                  type: string
      responses:
        '200':
          description: Access token
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
                    example: Bearer
                  expires_in:
                    type: integer
                    example: 3600

  /api/agent/v1/limits:
    get:
      operationId: getSpendingLimits
      summary: Get current spending limits
      tags:
        - Payments
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current spending limits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpendingLimits'

  /api/agent/v1/payments/token:
    post:
      operationId: requestPaymentToken
      summary: Request payment authorization
      description: |
        Request a payment token for a purchase. If the amount is within
        the agent's auto-approve limits, a token is returned immediately.
        If the amount exceeds limits, a step_up_id is returned and the
        user receives a push notification to approve.
      tags:
        - Payments
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
                - merchant_id
                - session_id
              properties:
                amount:
                  type: number
                  format: decimal
                  description: Payment amount in dollars
                  example: 25.99
                currency:
                  type: string
                  default: CAD
                merchant_id:
                  type: string
                  description: Merchant ID from store's UCP discovery
                session_id:
                  type: string
                  description: Checkout session ID from store
      responses:
        '200':
          description: Payment token or step-up required
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/PaymentTokenResponse'
                  - $ref: '#/components/schemas/StepUpRequired'

  /api/agent/v1/payments/token/{step_up_id}/status:
    get:
      operationId: getStepUpStatus
      summary: Check step-up approval status
      tags:
        - Payments
      security:
        - bearerAuth: []
      parameters:
        - name: step_up_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Step-up status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StepUpStatus'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Access token from /oauth/token

  schemas:
    SpendingLimits:
      type: object
      properties:
        per_transaction:
          type: number
          description: Maximum per-transaction amount (auto-approve)
        daily:
          type: number
          description: Daily spending limit
        daily_remaining:
          type: number
          description: Remaining daily allowance
        monthly:
          type: number
        monthly_remaining:
          type: number
        currency:
          type: string
          example: CAD

    PaymentTokenResponse:
      type: object
      properties:
        payment_token:
          type: string
          description: Token to submit to merchant for payment
        expires_at:
          type: string
          format: date-time

    StepUpRequired:
      type: object
      properties:
        step_up_required:
          type: boolean
          example: true
        step_up_id:
          type: string
          description: ID to poll for approval
        message:
          type: string
          example: "Amount exceeds auto-approve limit. User notified."

    StepUpStatus:
      type: object
      properties:
        status:
          type: string
          enum: [pending, approved, rejected, expired]
        payment_token:
          type: string
          description: Only present if approved
        expires_at:
          type: string
          format: date-time
```

---

## Task 2: Agent Discovery Document

**Endpoint**: `GET /.well-known/agent-api`
**Content-Type**: `application/json`

```json
{
  "name": "WSIM Agent API",
  "description": "Wallet service for AI agent payments",
  "version": "1.0.6",
  "documentation_url": "https://docs.banksim.ca/agent-api",

  "registration": {
    "method": "pairing_code",
    "endpoint": "/api/agent/v1/register",
    "description": "User generates a pairing code in their wallet app. Agent submits code to register.",
    "requires_human_approval": true
  },

  "authentication": {
    "type": "oauth2",
    "flow": "client_credentials",
    "token_endpoint": "/api/agent/v1/oauth/token",
    "discovery_url": "/.well-known/oauth-authorization-server"
  },

  "capabilities": [
    "payment_authorization",
    "spending_limits",
    "step_up_approval"
  ],

  "api": {
    "openapi_url": "/.well-known/openapi.json",
    "base_path": "/api/agent/v1"
  },

  "limits": {
    "rate_limit": "100 requests/minute",
    "token_expiry": "1 hour"
  }
}
```

---

## Task 3: OAuth Discovery (RFC 8414)

**Endpoint**: `GET /.well-known/oauth-authorization-server`
**Content-Type**: `application/json`

```json
{
  "issuer": "https://wsim.banksim.ca",
  "token_endpoint": "https://wsim.banksim.ca/api/agent/v1/oauth/token",
  "token_introspection_endpoint": "https://wsim.banksim.ca/api/agent/v1/oauth/introspect",
  "revocation_endpoint": "https://wsim.banksim.ca/api/agent/v1/oauth/revoke",
  "grant_types_supported": ["client_credentials"],
  "token_endpoint_auth_methods_supported": ["client_secret_post"],
  "response_types_supported": ["token"]
}
```

---

## Implementation Notes

### File Locations (suggested)

```
wsim/
├── src/routes/
│   └── well-known.ts         # New route for discovery endpoints
├── src/openapi/
│   └── agent-api.yaml        # OpenAPI spec source
```

### Route Implementation

```typescript
// src/routes/well-known.ts
import { Router } from 'express';
import agentOpenApiSpec from '../openapi/agent-api.json';

const router = Router();

// OpenAPI specification
router.get('/openapi.json', (req, res) => {
  res.json(agentOpenApiSpec);
});

// Agent discovery
router.get('/agent-api', (req, res) => {
  res.json({
    name: 'WSIM Agent API',
    description: 'Wallet service for AI agent payments',
    version: process.env.APP_VERSION || '1.0.6',
    // ... rest of discovery document
  });
});

// OAuth discovery (RFC 8414)
router.get('/oauth-authorization-server', (req, res) => {
  const baseUrl = process.env.APP_URL;
  res.json({
    issuer: baseUrl,
    token_endpoint: `${baseUrl}/api/agent/v1/oauth/token`,
    // ... rest of OAuth discovery
  });
});

export default router;
```

### Mount in Express app

```typescript
// src/index.ts or src/app.ts
import wellKnownRoutes from './routes/well-known';

app.use('/.well-known', wellKnownRoutes);
```

---

## Estimated Effort

| Task | Effort |
|------|--------|
| Write OpenAPI spec | 2-3 hours |
| Create discovery endpoints | 1-2 hours |
| Add route handlers | 1 hour |
| Testing | 1 hour |
| **Total** | **~1 day** |

---

## Acceptance Criteria

- [ ] `GET /.well-known/openapi.json` returns valid OpenAPI 3.0 spec
- [ ] `GET /.well-known/agent-api` returns agent discovery document
- [ ] `GET /.well-known/oauth-authorization-server` returns OAuth discovery
- [ ] All endpoints return proper `Content-Type: application/json`
- [ ] CORS headers allow cross-origin requests (for browser-based AI tools)
- [ ] Specs are accurate and match current API behavior

---

## Questions for WSIM Team

1. Should the OpenAPI spec be auto-generated from route definitions, or manually maintained?
2. Are there any additional endpoints that should be documented?
3. Should we version the discovery endpoints (e.g., `/.well-known/agent-api/v1`)?

---

## Contact

**Requestor**: PM
**WSIM Team Lead**: [TBD]
